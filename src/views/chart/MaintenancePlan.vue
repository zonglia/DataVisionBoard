<template>
  <div demo-bg>
    <dv-scroll-board v-if="showComponent" :config="config" />
  </div>
</template>
<script lang="ts" setup>
import { reactive, onBeforeMount, onUnmounted, onMounted, ref } from "vue";

let reloadTimer: number | null = null;

const showComponent = ref(true);
// 定义向父组件发送事件的 emit
const emit = defineEmits(["refresh-time-updated"]);




const config = reactive({
  header: ["工序", "设备名称", "保养频率", "本次保养时间", "下次保养时间"],
  data: [] as string[][],
  index: true,
  columnWidth: [50],
  align: ["center"],
  rowNum: [15],
  headerBGC: ["transparent"],
  evenRowBGC: ["transparent"],
  oddRowBGC: ["#026CCA80"],
});

// 在 DOM 渲染前初始化数据
onBeforeMount(() => {
  config.data = initData(); // 同步或异步操作
  updateTime();
});

// 重新加载组件
const reloadComponent = () => {

  showComponent.value = false;
  // 短暂延迟确保组件完全卸载
  setTimeout(() => {
    showComponent.value = true;
    refreshData();
  }, 100); 

  // 更新时间并通知父组件
  updateTime();
};

// 更新刷新时间
const updateTime = () => {
  const now = new Date();
  const lastRefreshTime = `${now.getFullYear()}/${
    now.getMonth() + 1
  }/${now.getDate()} ${String(now.getHours()).padStart(2, "0")}:${String(
    now.getMinutes()
  ).padStart(2, "0")}:${String(now.getSeconds()).padStart(2, "0")}`;
  emit("refresh-time-updated", lastRefreshTime);
};


// 初始化数据并更新表格
const refreshData = () => {
  config.data = initData(); // 重新生成数据
};




onMounted(() => {
  // 设置定时器，每隔30秒重新加载组件
  reloadTimer = setInterval(reloadComponent, 20000);
});

onUnmounted(() => {
  // 组件卸载时清除定时器
  if (reloadTimer) {
    clearInterval(reloadTimer);
  }
});

// 初始化数据
const initData = () => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const rawData = [
    ["开料", "裁切机", "1次/周", "2025年3月27日", "2025年4月4日"],
    ["开料", "铝基板开料机", "1次/周", "2025年3月27日", "2025年4月4日"],
    ["开料", "磨边线", "1次/周", "2025年3月27日", "2025年4月4日"],
    ["开料", "烤箱", "1次/周", "2025年3月27日", "2025年4月4日"],
    ["钻孔", "上PIN机", "1次/月", "2025年3月3日", "2025年4月3日"],
    ["钻孔", "机械钻机1#", "1次/月", "2025年3月3日", "2025年4月3日"],
    ["钻孔", "机械钻机2#", "1次/月", "2025年3月4日", "2025年4月4日"],
    ["钻孔", "机械钻机3#", "1次/月", "2025年3月5日", "2025年4月5日"],
    ["钻孔", "机械钻机4#", "1次/月", "2025年3月6日", "2025年4月6日"],
    ["钻孔", "机械钻机5#", "1次/月", "2025年3月7日", "2025年4月7日"],
    ["钻孔", "机械钻机6#", "1次/月", "2025年3月8日", "2025年4月8日"],
    ["钻孔", "机械钻机7#", "1次/月", "2025年3月9日", "2025年4月9日"],
    ["钻孔", "机械钻机8#", "1次/月", "2025年3月10日", "2025年4月10日"],
    ["钻孔", "机械钻机9#", "1次/月", "2025年3月11日", "2025年4月11日"],
    ["钻孔", "机械钻机10#", "1次/月", "2025年3月12日", "2025年4月12日"],
    ["钻孔", "验孔机", "1次/月", "2025年3月13日", "2025年4月13日"],
    ["钻孔", "研磨机1#", "1次/月", "2025年3月14日", "2025年4月14日"],
    ["钻孔", "研磨机2#", "1次/月", "2025年3月15日", "2025年4月15日"],
    ["钻孔", "研磨机3#", "1次/月", "2025年3月16日", "2025年4月16日"],
    ["电镀", "日蚀线1#", "1次/周", "2025年3月27日", "2025年4月4日"],
    ["电镀", "日蚀线2#", "1次/周", "2025年3月28日", "2025年4月5日"],
    ["电镀", "VCP线1#", "1次/周", "2025年3月26日", "2025年4月3日"],
    ["电镀", "VCP线2#", "1次/周", "2025年3月27日", "2025年4月4日"],
    ["电镀", "磨板机", "1次/周", "2025年3月28日", "2025年4月5日"],
    ["线路", "前处理压膜1#", "1次/周", "2025年3月22日", "2025年3月29日"],
    ["线路", "前处理压膜2#", "1次/周", "2025年3月23日", "2025年3月30日"],
    [
      "线路",
      "前处理滚涂DI蚀刻连线1#",
      "1次/周",
      "2025年3月22日",
      "2025年3月29日",
    ],
    [
      "线路",
      "前处理滚涂DI蚀刻连线2#",
      "1次/周",
      "2025年3月23日",
      "2025年3月30日",
    ],
    ["线路", "手动曝光机1#", "1次/15天", "2025年3月15日", "2025年3月31日"],
    ["线路", "手动曝光机2#", "1次/15天", "2025年3月14日", "2025年3月30日"],
    ["线路", "LDI曝光连线", "1次/15天", "2025年3月13日", "2025年3月29日"],
    ["线路", "蚀刻线1#", "1次/周", "2025年3月23日", "2025年3月30日"],
    ["线路", "蚀刻线2#", "1次/周", "2025年3月22日", "2025年3月29日"],
    ["AOI", "AOI+VRS1#", "1次/周", "2025年3月25日", "2025年4月1日"],
    ["AOI", "AOI+VRS2#", "1次/周", "2025年3月26日", "2025年4月2日"],
    ["AOI", "AOI+VRS3#", "1次/周", "2025年3月27日", "2025年4月3日"],
    ["菲林房", "光绘机1#", "1次/周", "2025年3月3日", "2025年3月10日"],
    ["菲林房", "光绘机2#", "1次/周", "2025年3月4日", "2025年3月11日"],
    ["菲林房", "底片检查机", "1次/周", "2025年3月5日", "2025年3月12日"],
    ["防焊", "前处理1#", "1次/周", "2025年3月6日", "2025年3月13日"],
    ["防焊", "前处理2#", "1次/周", "2025年3月7日", "2025年3月14日"],
    ["防焊", "前处理3#", "1次/周", "2025年3月8日", "2025年3月15日"],
    ["防焊", "半自动丝印机1#", "1次/周", "2025年3月9日", "2025年3月16日"],
    ["防焊", "半自动丝印机2#", "1次/周", "2025年3月10日", "2025年3月17日"],
    ["防焊", "半自动丝印机3#", "1次/周", "2025年3月11日", "2025年3月18日"],
    ["防焊", "自动印刷机", "1次/周", "2025年3月12日", "2025年3月19日"],
    ["防焊", "隧道烤箱", "1次/周", "2025年3月13日", "2025年3月20日"],
    ["防焊", "ORC曝光机1#", "1次/周", "2025年3月14日", "2025年3月21日"],
    ["防焊", "ORC曝光机2#", "1次/周", "2025年3月15日", "2025年3月22日"],
    ["防焊", "滚涂预烤连线1#", "1次/周", "2025年3月16日", "2025年3月23日"],
    ["防焊", "滚涂预烤连线2#", "1次/周", "2025年3月17日", "2025年3月24日"],
    ["防焊", "科视曝光机", "1次/周", "2025年3月18日", "2025年3月25日"],
    ["防焊", "显影线1#", "1次/周", "2025年3月19日", "2025年3月26日"],
    ["防焊", "显影线2#", "1次/周", "2025年3月20日", "2025年3月27日"],
    ["文字", "手动丝印机1#", "1次/周", "2025年3月21日", "2025年3月28日"],
    ["文字", "手动丝印机2#", "1次/周", "2025年3月22日", "2025年3月29日"],
    ["文字", "手动丝印机3#", "1次/周", "2025年3月23日", "2025年3月30日"],
    ["文字", "手动丝印机4#", "1次/周", "2025年3月24日", "2025年3月31日"],
    ["文字", "手动丝印机5#", "1次/周", "2025年3月25日", "2025年4月1日"],
    ["文字", "手动丝印机6#", "1次/周", "2025年3月26日", "2025年4月2日"],
    ["文字", "隧道烤箱1#", "1次/周", "2025年3月27日", "2025年4月3日"],
    ["文字", "隧道烤箱2#", "1次/周", "2025年3月15日", "2025年4月4日"],
    ["文字", "拉网机", "1次/周", "2025年3月16日", "2025年4月5日"],
    ["文字", "上浆机", "1次/周", "2025年3月17日", "2025年4月6日"],
    ["文字", "曝光机", "1次/周", "2025年3月18日", "2025年4月7日"],
    ["整板压烤", "整板压烤1#", "1次/周", "2025年3月19日", "2025年4月8日"],
    ["整板压烤", "整板压烤2#", "1次/周", "2025年3月20日", "2025年4月9日"],
    ["成型", "成型机1#", "1次/月", "2025年3月21日", "2025年4月21日"],
    ["成型", "成型机2#", "1次/月", "2025年3月22日", "2025年4月22日"],
    ["成型", "成型机3#", "1次/月", "2025年3月23日", "2025年4月23日"],
    ["成型", "成型机4#", "1次/月", "2025年3月24日", "2025年4月24日"],
    ["成型", "成型机5#", "1次/月", "2025年3月25日", "2025年4月25日"],
    ["打码", "打码机", "1次/月", "2025年3月26日", "2025年4月26日"],
    ["冲型", "冲压机", "1次/月", "2025年3月27日", "2025年4月27日"],
    ["成型", "清洗线1#", "1次/月", "2025年3月22日", "2025年4月21日"],
    ["成型", "清洗线2#", "1次/月", "2025年3月23日", "2025年4月22日"],
    ["电测", "专用电测机1#", "1次/月", "2025年3月3日", "2025年4月3日"],
    ["电测", "专用电测机2#", "1次/月", "2025年3月3日", "2025年4月3日"],
    ["电测", "专用电测机3#", "1次/月", "2025年3月3日", "2025年4月3日"],
    ["电测", "专用电测机4#", "1次/月", "2025年3月3日", "2025年4月3日"],
    ["电测", "专用电测机5#", "1次/月", "2025年3月3日", "2025年4月3日"],
    ["电测", "专用电测机6#", "1次/月", "2025年3月3日", "2025年4月3日"],
    ["电测", "大台面专用测试机1#", "1次/月", "2025年3月2日", "2025年4月2日"],
    ["电测", "大台面专用测试机2#", "1次/月", "2025年3月2日", "2025年4月2日"],
    ["电测", "飞针机1#", "1次/月", "2025年3月4日", "2025年4月7日"],
    ["电测", "飞针机2#", "1次/月", "2025年3月4日", "2025年4月7日"],
    ["电测", "飞针机3#", "1次/月", "2025年3月4日", "2025年4月7日"],
    ["电测", "飞针机4#", "1次/月", "2025年3月4日", "2025年4月7日"],
    ["电测", "飞针机5#", "1次/月", "2025年3月4日", "2025年4月7日"],
    ["AVI", "AVI机1#", "1次/月", "2025年3月2日", "2025年4月2日"],
    ["AVI", "AVI机2#", "1次/月", "2025年3月2日", "2025年4月2日"],
    ["OSP", "OSP线1#", "1次/月", "2025年3月2日", "2025年4月2日"],
    ["OSP", "OSP线2#", "1次/月", "2025年3月3日", "2025年4月3日"],
    ["包装", "真空包装机", "1次/月", "2025年3月2日", "2025年4月2日"],
  ];
  return rawData.map((item) => {
    const lastDate = parseDate(item[3]);
    const nextDate = parseDate(item[4]);
    const frequency = item[2];

    // 如果下次保养时间是今天或之前，则更新保养记录
    if (nextDate <= today) {
      const newLastDate = new Date(today);
      const newNextDate = calculateNextMaintenance(frequency, newLastDate);

      return [
        item[0],
        item[1],
        frequency,
        formatDate(newLastDate),
        formatDate(newNextDate),
      ];
    }

    return [...item];
  });
};

// 计算下次保养时间
const calculateNextMaintenance = (frequency: string, lastDate: Date): Date => {
  const nextDate = new Date(lastDate);

  if (frequency.includes("周")) {
    const weeks = parseInt(frequency.split("/")[0]);
    nextDate.setDate(nextDate.getDate() + weeks * 7);
  } else if (frequency.includes("月")) {
    const months = parseInt(frequency.split("/")[0]);
    nextDate.setMonth(nextDate.getMonth() + months);
  } else if (frequency.includes("15天")) {
    nextDate.setDate(nextDate.getDate() + 15);
  } else if (frequency.includes("天")) {
    const days = parseInt(frequency.split("/")[0]);
    nextDate.setDate(nextDate.getDate() + days);
  }

  return nextDate;
};

// 格式化日期为"YYYY年MM月DD日"
const formatDate = (date: Date): string => {
  const year = date.getFullYear();
  const month = (date.getMonth() + 1).toString().padStart(2, "0");
  const day = date.getDate().toString().padStart(2, "0");
  return `${year}年${month}月${day}日`;
};

// 解析日期字符串为Date对象
const parseDate = (dateStr: string): Date => {
  const [year, month, day] = dateStr
    .split(/[年月日]/)
    .filter(Boolean)
    .map(Number);
  return new Date(year, month - 1, day);
};
</script>

<style scoped lang="scss">
:deep(.dv-scroll-board) {
  .header {
    font-size: 0.25rem;
    background-color: transparent !important;
    .header-item {
      text-align: center;
    }
  }

  .rows {
    .row-item {
      font-size: 0.18rem;
      border-radius: 0.1rem;
      .ceil {
        text-align: center;
      }
    }
  }
}
</style>
